var LeadLoopr=(()=>{var l=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var k=(t,e)=>{for(var o in e)l(t,o,{get:e[o],enumerable:!0})},T=(t,e,o,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of F(e))!S.call(t,n)&&n!==o&&l(t,n,{get:()=>e[n],enumerable:!(a=h(e,n))||a.enumerable});return t};var D=t=>T(l({},"__esModule",{value:!0}),t);var ct={};k(ct,{init:()=>st});var A="leadloopr-tracker",u="data-org-id",I="data-debug",R="data-endpoint",O="data-feature-flags",P="https://api.leadloopr.com/track/lead",c={allowConsentFallback:!0,allowDynamicForms:!0};function v(){let t=document.getElementById(A);return t?.tagName==="SCRIPT"?t:Array.from(document.getElementsByTagName("script")).find(o=>o.src.includes("leadloopr-tracker.js"))||null}function M(t){let e=t.getAttribute(u);if(!e||e.trim()==="")throw new Error(`LeadLoopr: Missing required attribute "${u}" on script tag. Please add data-org-id="your-organization-id" to the script tag.`);return e.trim()}function N(t){let e=t.getAttribute(I),o=window.LEADLOOPR_DEBUG;return e!==null?e==="true"||e==="1":o===!0}function x(t){return t.getAttribute(R)?.trim()||P}function U(t){let e=t.getAttribute(O);if(!e)return c;try{let o=JSON.parse(e);return{allowConsentFallback:o.allowConsentFallback??c.allowConsentFallback,allowDynamicForms:o.allowDynamicForms??c.allowDynamicForms}}catch(o){return console.warn("LeadLoopr: Invalid feature flags JSON, using defaults:",o),c}}function H(t){if(!t.orgId||t.orgId.trim()==="")throw new Error("LeadLoopr: Organization ID cannot be empty");if(!t.endpoint||t.endpoint.trim()==="")throw new Error("LeadLoopr: Endpoint cannot be empty");try{new URL(t.endpoint)}catch{throw new Error(`LeadLoopr: Invalid endpoint URL: ${t.endpoint}`)}}function g(){let t=v();if(!t)throw new Error('LeadLoopr: Could not find tracker script tag. Make sure the script has id="leadloopr-tracker" or src contains "leadloopr-tracker.js"');let e={orgId:M(t),debug:N(t),endpoint:x(t),featureFlags:U(t)};return H(e),e.debug&&console.log("LeadLoopr: Config loaded successfully:",{orgId:e.orgId,debug:e.debug,endpoint:e.endpoint,featureFlags:e.featureFlags}),e}var $="cookie_consent",z="leadloopr_consent";function G(){return new Promise(t=>{if(typeof window.gtag!="function"){t({granted:!1,reason:"none"});return}window.gtag("consent","get",e=>{let o=e?.ad_storage==="granted"||e?.analytics_storage==="granted"||e?.functionality_storage==="granted";t({granted:o,reason:o?"google-consent":"none"})})})}function j(){let e=document.cookie.split(";").some(o=>o.trim().startsWith(`${$}=true`));return{granted:e,reason:e?"fallback-cookie":"none"}}function B(){let t=localStorage.getItem(z)==="true";return{granted:t,reason:t?"fallback-localStorage":"none"}}async function m(t){t.debug&&console.log("LeadLoopr: Checking consent status...");let e=await G();if(e.granted)return t.debug&&console.log("LeadLoopr: Consent granted via Google Consent Mode"),e;if(!t.featureFlags.allowConsentFallback)return t.debug&&console.log("LeadLoopr: Consent fallback disabled, no consent granted"),{granted:!1,reason:"none"};let o=j();if(o.granted)return t.debug&&console.log("LeadLoopr: Consent granted via cookie"),o;let a=B();return a.granted?(t.debug&&console.log("LeadLoopr: Consent granted via localStorage"),a):(t.debug&&console.log("LeadLoopr: No consent granted"),{granted:!1,reason:"none"})}var q=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],J=["gclid","fbclid","li_fat_id"],p="leadloopr_attribution";function K(){try{let t=document.querySelector('link[rel="canonical"]');return t?.href?t.href:window.location.href}catch{return window.location.href}}function W(t){let e={};try{let a=new URL(t).searchParams;q.forEach(n=>{let r=a.get(n);r&&r.trim()&&(e[n]=r.trim())}),J.forEach(n=>{let r=a.get(n);r&&r.trim()&&(e[n]=r.trim())})}catch(o){console.warn("LeadLoopr: Failed to parse URL parameters:",o)}return e}function Y(){try{let t=document.referrer;return t&&t.trim()&&!t.startsWith(window.location.origin)?t.trim():void 0}catch(t){console.warn("LeadLoopr: Failed to get referrer:",t);return}}function X(){try{let t=sessionStorage.getItem(p);if(t)return JSON.parse(t)}catch(t){console.warn("LeadLoopr: Failed to read cached attribution:",t)}return null}function Z(t){try{sessionStorage.setItem(p,JSON.stringify(t))}catch(e){console.warn("LeadLoopr: Failed to cache attribution:",e)}}function f(t){return typeof t.landing_page=="string"&&t.landing_page.length>0&&typeof t.timestamp=="number"&&t.timestamp>0}function L(t){t.debug&&console.log("LeadLoopr: Initializing attribution tracking");let e=X();if(e&&f(e))return t.debug&&console.log("LeadLoopr: Using cached attribution data"),e;let o=K(),a=W(o),n=Y(),r={landing_page:o,referrer:n,...a,timestamp:Date.now()};return f(r)||(t.debug&&console.warn("LeadLoopr: Generated invalid attribution data, using fallback"),r.landing_page=window.location.href,r.timestamp=Date.now()),Z(r),t.debug&&console.log("LeadLoopr: Attribution data captured:",{landing_page:r.landing_page,referrer:r.referrer,utm_params:{utm_source:r.utm_source,utm_medium:r.utm_medium,utm_campaign:r.utm_campaign,utm_term:r.utm_term,utm_content:r.utm_content},click_ids:{gclid:r.gclid,fbclid:r.fbclid,li_fat_id:r.li_fat_id},timestamp:r.timestamp}),r}var Q=["name","full_name","first_name","last_name","email","user_email","phone","tel","telephone","mobile","cell"];function V(t){let e=t.toLowerCase().replace(/[_-]/g,"");return Q.some(o=>e.includes(o.toLowerCase().replace(/[_-]/g,"")))}function b(t,e,o=!1){if(o&&console.log("LeadLoopr: Filtering form data for consent:",{consent:e,rawData:t}),e.granted)return o&&console.log("LeadLoopr: Consent granted, including all data"),{data:t,excluded:[]};let a={},n=[];return Object.entries(t).forEach(([r,i])=>{i&&!V(r)?a[r]=i:i&&n.push(r)}),o&&console.log("LeadLoopr: Consent not granted, filtered data:",{included:Object.keys(a),excluded:n}),{data:a,excluded:n}}var tt=[500,1500,3e3];async function et(t){return new Promise(e=>setTimeout(e,t))}async function ot(t,e,o,a){try{let n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"omit",body:JSON.stringify(t)});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return a&&console.log("LeadLoopr: Lead payload sent successfully"),!0}catch(n){return a&&console.warn(`LeadLoopr: Send attempt ${o} failed:`,n),!1}}async function _(t,e,o=!1){o&&console.log("LeadLoopr: Sending lead payload:",t);let a=!1,n=0;for(;!a&&n<3;){if(n>0){let r=tt[n-1];o&&console.log(`LeadLoopr: Retrying in ${r}ms (attempt ${n+1}/3)`),await et(r)}a=await ot(t,e,n+1,o),n++}!a&&o&&console.error("LeadLoopr: Failed to send lead payload after all retries")}var nt={name:["name","full_name","first_name","last_name","fullname","fullName"],email:["email","user_email","userEmail","e-mail","mail"],phone:["phone","tel","telephone","mobile","cell"]};function rt(t,e){for(let o of e){let a=t.querySelector(`[name="${o}"], [id="${o}"], [name*="${o}"], [id*="${o}"]`);if(a?.value)return a.value.trim()}}function at(t){let e=new FormData(t),o={};return Object.entries(nt).forEach(([a,n])=>{let r=rt(t,n);r&&(o[a]=r)}),e.forEach((a,n)=>{typeof a=="string"&&a.trim()&&(o[n]=a.trim())}),o}async function E(t,e,o,a){let n=t.target;if(n.hasAttribute("data-leadloopr-tracked"))return;n.setAttribute("data-leadloopr-tracked","true");let r=at(n),{data:i,excluded:s}=b(r,a,e.debug);e.debug&&console.log("LeadLoopr: Form submitted:",{form:n.id||n.name||"unnamed",rawData:r,filteredData:i,excluded:s,attribution:o}),await _({org_id:e.orgId,timestamp:Date.now(),attribution:o,consent:a,form_data:i},e.endpoint,e.debug)}function w(t,e,o){t.debug&&console.log("LeadLoopr: Initializing form tracking");let a=document.querySelectorAll("form");t.debug&&console.log(`LeadLoopr: Found ${a.length} forms to track`),a.forEach(n=>{n.addEventListener("submit",r=>E(r,t,e,o))}),t.featureFlags.allowDynamicForms?(new MutationObserver(r=>{r.forEach(i=>{i.addedNodes.forEach(s=>{s instanceof HTMLElement&&s.querySelectorAll("form").forEach(d=>{d.hasAttribute("data-leadloopr-tracked")||d.addEventListener("submit",C=>E(C,t,e,o))})})})}).observe(document.body,{childList:!0,subtree:!0}),t.debug&&console.log("LeadLoopr: Dynamic form tracking enabled")):t.debug&&console.log("LeadLoopr: Dynamic form tracking disabled"),t.debug&&console.log("LeadLoopr: Form tracking initialized")}async function it(t){t.debug&&console.log("LeadLoopr: Starting initialization");let e=await m(t);if(!e.granted){t.debug&&console.log("LeadLoopr: Consent not granted, reason:",e.reason);return}let o=L(t);w(t,o,e),t.debug&&console.log("LeadLoopr: Initialization complete")}function y(){if(window.__LEADLOOPR_INITIALIZED__){console.warn("LeadLoopr: Script already initialized");return}let t=async()=>{try{let e=g();await it(e),window.__LEADLOOPR_INITIALIZED__=!0}catch(e){console.error("LeadLoopr: Initialization failed:",e)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}var st=()=>{y()};return D(ct);})();
