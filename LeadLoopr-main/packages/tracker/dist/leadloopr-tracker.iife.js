(function(c){"use strict";const L="leadloopr-tracker",d="data-org-id",b="data-debug",_="data-endpoint",h="data-feature-flags",w="https://api.leadloopr.com/track/lead",s={allowConsentFallback:!0,allowDynamicForms:!0};function y(){const e=document.getElementById(L);return(e==null?void 0:e.tagName)==="SCRIPT"?e:Array.from(document.getElementsByTagName("script")).find(o=>o.src.includes("leadloopr-tracker.js"))||null}function E(e){const t=e.getAttribute(d);if(!t||t.trim()==="")throw new Error(`LeadLoopr: Missing required attribute "${d}" on script tag. Please add data-org-id="your-organization-id" to the script tag.`);return t.trim()}function k(e){const t=e.getAttribute(b),o=window.LEADLOOPR_DEBUG;return t!==null?t==="true"||t==="1":o===!0}function S(e){const t=e.getAttribute(_);return(t==null?void 0:t.trim())||w}function F(e){const t=e.getAttribute(h);if(!t)return s;try{const o=JSON.parse(t);return{allowConsentFallback:o.allowConsentFallback??s.allowConsentFallback,allowDynamicForms:o.allowDynamicForms??s.allowDynamicForms}}catch(o){return console.warn("LeadLoopr: Invalid feature flags JSON, using defaults:",o),s}}function I(e){if(!e.orgId||e.orgId.trim()==="")throw new Error("LeadLoopr: Organization ID cannot be empty");if(!e.endpoint||e.endpoint.trim()==="")throw new Error("LeadLoopr: Endpoint cannot be empty");try{new URL(e.endpoint)}catch{throw new Error(`LeadLoopr: Invalid endpoint URL: ${e.endpoint}`)}}function C(){const e=y();if(!e)throw new Error('LeadLoopr: Could not find tracker script tag. Make sure the script has id="leadloopr-tracker" or src contains "leadloopr-tracker.js"');const t={orgId:E(e),debug:k(e),endpoint:S(e),featureFlags:F(e)};return I(t),t.debug&&console.log("LeadLoopr: Config loaded successfully:",{orgId:t.orgId,debug:t.debug,endpoint:t.endpoint,featureFlags:t.featureFlags}),t}const A="cookie_consent",T="leadloopr_consent";function D(){return new Promise(e=>{if(typeof window.gtag!="function"){e({granted:!1,reason:"none"});return}window.gtag("consent","get",t=>{const o=(t==null?void 0:t.ad_storage)==="granted"||(t==null?void 0:t.analytics_storage)==="granted"||(t==null?void 0:t.functionality_storage)==="granted";e({granted:o,reason:o?"google-consent":"none"})})})}function O(){const t=document.cookie.split(";").some(o=>o.trim().startsWith(`${A}=true`));return{granted:t,reason:t?"fallback-cookie":"none"}}function R(){const e=localStorage.getItem(T)==="true";return{granted:e,reason:e?"fallback-localStorage":"none"}}async function N(e){e.debug&&console.log("LeadLoopr: Checking consent status...");const t=await D();if(t.granted)return e.debug&&console.log("LeadLoopr: Consent granted via Google Consent Mode"),t;if(!e.featureFlags.allowConsentFallback)return e.debug&&console.log("LeadLoopr: Consent fallback disabled, no consent granted"),{granted:!1,reason:"none"};const o=O();if(o.granted)return e.debug&&console.log("LeadLoopr: Consent granted via cookie"),o;const a=R();return a.granted?(e.debug&&console.log("LeadLoopr: Consent granted via localStorage"),a):(e.debug&&console.log("LeadLoopr: No consent granted"),{granted:!1,reason:"none"})}const P=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],v=["gclid","fbclid","li_fat_id"],u="leadloopr_attribution";function U(){try{const e=document.querySelector('link[rel="canonical"]');return e!=null&&e.href?e.href:window.location.href}catch{return window.location.href}}function $(e){const t={};try{const a=new URL(e).searchParams;P.forEach(n=>{const r=a.get(n);r&&r.trim()&&(t[n]=r.trim())}),v.forEach(n=>{const r=a.get(n);r&&r.trim()&&(t[n]=r.trim())})}catch(o){console.warn("LeadLoopr: Failed to parse URL parameters:",o)}return t}function z(){try{const e=document.referrer;return e&&e.trim()&&!e.startsWith(window.location.origin)?e.trim():void 0}catch(e){console.warn("LeadLoopr: Failed to get referrer:",e);return}}function M(){try{const e=sessionStorage.getItem(u);if(e)return JSON.parse(e)}catch(e){console.warn("LeadLoopr: Failed to read cached attribution:",e)}return null}function G(e){try{sessionStorage.setItem(u,JSON.stringify(e))}catch(t){console.warn("LeadLoopr: Failed to cache attribution:",t)}}function g(e){return typeof e.landing_page=="string"&&e.landing_page.length>0&&typeof e.timestamp=="number"&&e.timestamp>0}function j(e){e.debug&&console.log("LeadLoopr: Initializing attribution tracking");const t=M();if(t&&g(t))return e.debug&&console.log("LeadLoopr: Using cached attribution data"),t;const o=U(),a=$(o),n=z(),r={landing_page:o,referrer:n,...a,timestamp:Date.now()};return g(r)||(e.debug&&console.warn("LeadLoopr: Generated invalid attribution data, using fallback"),r.landing_page=window.location.href,r.timestamp=Date.now()),G(r),e.debug&&console.log("LeadLoopr: Attribution data captured:",{landing_page:r.landing_page,referrer:r.referrer,utm_params:{utm_source:r.utm_source,utm_medium:r.utm_medium,utm_campaign:r.utm_campaign,utm_term:r.utm_term,utm_content:r.utm_content},click_ids:{gclid:r.gclid,fbclid:r.fbclid,li_fat_id:r.li_fat_id},timestamp:r.timestamp}),r}const q=["name","full_name","first_name","last_name","email","user_email","phone","tel","telephone","mobile","cell"];function B(e){const t=e.toLowerCase().replace(/[_-]/g,"");return q.some(o=>t.includes(o.toLowerCase().replace(/[_-]/g,"")))}function J(e,t,o=!1){if(o&&console.log("LeadLoopr: Filtering form data for consent:",{consent:t,rawData:e}),t.granted)return o&&console.log("LeadLoopr: Consent granted, including all data"),{data:e,excluded:[]};const a={},n=[];return Object.entries(e).forEach(([r,i])=>{i&&!B(r)?a[r]=i:i&&n.push(r)}),o&&console.log("LeadLoopr: Consent not granted, filtered data:",{included:Object.keys(a),excluded:n}),{data:a,excluded:n}}const m=3,K=[500,1500,3e3];async function x(e){return new Promise(t=>setTimeout(t,e))}async function Y(e,t,o,a){try{const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"omit",body:JSON.stringify(e)});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return a&&console.log("LeadLoopr: Lead payload sent successfully"),!0}catch(n){return a&&console.warn(`LeadLoopr: Send attempt ${o} failed:`,n),!1}}async function H(e,t,o=!1){o&&console.log("LeadLoopr: Sending lead payload:",e);let a=!1,n=0;for(;!a&&n<m;){if(n>0){const r=K[n-1];o&&console.log(`LeadLoopr: Retrying in ${r}ms (attempt ${n+1}/${m})`),await x(r)}a=await Y(e,t,n+1,o),n++}!a&&o&&console.error("LeadLoopr: Failed to send lead payload after all retries")}const Q={name:["name","full_name","first_name","last_name","fullname","fullName"],email:["email","user_email","userEmail","e-mail","mail"],phone:["phone","tel","telephone","mobile","cell"]};function W(e,t){for(const o of t){const a=e.querySelector(`[name="${o}"], [id="${o}"], [name*="${o}"], [id*="${o}"]`);if(a!=null&&a.value)return a.value.trim()}}function Z(e){const t=new FormData(e),o={};return Object.entries(Q).forEach(([a,n])=>{const r=W(e,n);r&&(o[a]=r)}),t.forEach((a,n)=>{typeof a=="string"&&a.trim()&&(o[n]=a.trim())}),o}async function f(e,t,o,a){const n=e.target;if(n.hasAttribute("data-leadloopr-tracked"))return;n.setAttribute("data-leadloopr-tracked","true");const r=Z(n),{data:i,excluded:l}=J(r,a,t.debug);t.debug&&console.log("LeadLoopr: Form submitted:",{form:n.id||n.name||"unnamed",rawData:r,filteredData:i,excluded:l,attribution:o}),await H({org_id:t.orgId,timestamp:Date.now(),attribution:o,consent:a,form_data:i},t.endpoint,t.debug)}function V(e,t,o){e.debug&&console.log("LeadLoopr: Initializing form tracking");const a=document.querySelectorAll("form");e.debug&&console.log(`LeadLoopr: Found ${a.length} forms to track`),a.forEach(n=>{n.addEventListener("submit",r=>f(r,e,t,o))}),e.featureFlags.allowDynamicForms?(new MutationObserver(r=>{r.forEach(i=>{i.addedNodes.forEach(l=>{l instanceof HTMLElement&&l.querySelectorAll("form").forEach(p=>{p.hasAttribute("data-leadloopr-tracked")||p.addEventListener("submit",oe=>f(oe,e,t,o))})})})}).observe(document.body,{childList:!0,subtree:!0}),e.debug&&console.log("LeadLoopr: Dynamic form tracking enabled")):e.debug&&console.log("LeadLoopr: Dynamic form tracking disabled"),e.debug&&console.log("LeadLoopr: Form tracking initialized")}async function X(e){e.debug&&console.log("LeadLoopr: Starting initialization");const t=await N(e);if(!t.granted){e.debug&&console.log("LeadLoopr: Consent not granted, reason:",t.reason);return}const o=j(e);V(e,o,t),e.debug&&console.log("LeadLoopr: Initialization complete")}function ee(){if(window.__LEADLOOPR_INITIALIZED__){console.warn("LeadLoopr: Script already initialized");return}const e=async()=>{try{const t=C();await X(t),window.__LEADLOOPR_INITIALIZED__=!0}catch(t){console.error("LeadLoopr: Initialization failed:",t)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e()}const te=()=>{ee()};c.init=te,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})})(this.LeadLooprTracker=this.LeadLooprTracker||{});
//# sourceMappingURL=leadloopr-tracker.iife.js.map
